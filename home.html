<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Terminal Home Page</title>

        <!-- Google Fonts CDN for Fira Code -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap"
            rel="stylesheet"
        />

        <!-- cdnjs for Font Awesome Icons -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
            integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />

        <style>
            :root {
                --background-color: #1a1b26;
                --foreground-color: #a9b1d6;
                --accent-color: #7aa2f7;
                --green: #9ece6a;
                --yellow: #e0af68;
                --red: #f7768e;
                --cyan: #7dcfff;
                --gray: #414868;
                --font: "Fira Code", "Courier New", "monospace";
            }
            * {
                box-sizing: border-box;
            }
            body {
                background-color: var(--background-color);
                color: var(--foreground-color);
                font-family: var(--font);
                margin: 0;
                padding: 0;
                min-height: 100vh;
                font-size: 14px;
                display: flex;
                flex-direction: column;
            }
            .main-container {
                display: flex;
                flex: 1;
                gap: 1rem;
                padding: 1rem;
                max-height: calc(100vh - 60px);
            }
            .left-panel {
                flex: 1;
                border: 2px solid var(--foreground-color);
                padding: 1rem;
                background-color: var(--background-color);
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            .rss-header {
                font-size: 1.5rem;
                color: var(--accent-color);
                font-weight: bold;
                text-align: center;
                margin-bottom: 1rem;
                border-bottom: 1px solid var(--gray);
                padding-bottom: 0.5rem;
            }
            .rss-content {
                flex: 1;
                overflow-y: auto;
                padding-right: 0.5rem;
            }
            .rss-loading {
                text-align: center;
                color: var(--yellow);
                font-size: 1rem;
                margin: 2rem 0;
            }
            .rss-item {
                border-bottom: 1px solid var(--gray);
                padding: 1rem 0;
                margin-bottom: 1rem;
            }
            .rss-item:last-child {
                border-bottom: none;
            }
            .rss-title {
                color: var(--cyan);
                font-weight: bold;
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
                line-height: 1.3;
                cursor: pointer;
                text-decoration: none;
            }
            .rss-title:hover {
                color: var(--accent-color);
                text-decoration: underline;
            }
            .rss-description {
                color: var(--foreground-color);
                font-size: 0.8rem;
                line-height: 1.4;
                margin-bottom: 0.5rem;
                display: -webkit-box;
                -webkit-line-clamp: 3;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
            .rss-meta {
                color: var(--gray);
                font-size: 0.7rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .rss-source {
                color: var(--green);
                font-weight: bold;
            }
            .right-panel {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 1rem;
                overflow-y: auto;
            }
            .widget-box {
                border: 1px solid var(--gray);
                padding: 1rem;
                background-color: var(--background-color);
            }
            .cursor {
                display: inline-block;
                width: 10px;
                height: 1.2em;
                background-color: var(--foreground-color);
                animation: blink 1s steps(1) infinite;
                vertical-align: middle;
                margin-left: 4px;
            }
            @keyframes blink {
                50% {
                    background-color: transparent;
                }
            }
            .label {
                color: var(--accent-color);
                font-weight: bold;
            }
            .label i,
            .stat-header .title i {
                color: var(--cyan);
                margin-right: 0.6rem;
                min-width: 20px;
                text-align: center;
            }
            .header {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            #time-widget,
            #weather-widget {
                display: block;
                margin-bottom: 0.5rem;
            }
            .link-grid {
                display: grid;
                gap: 0.5rem;
                grid-template-columns: repeat(4, 1fr);
                grid-template-rows: repeat(2, 1fr);
            }
            .link-button {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 0.25rem;
                padding: 0.75rem 0.5rem;
                background-color: var(--gray);
                color: var(--foreground-color);
                text-decoration: none;
                border-radius: 4px;
                transition:
                    background-color 0.2s ease,
                    color 0.2s ease;
                font-size: 0.8rem;
            }
            .link-button:hover {
                background-color: var(--accent-color);
                color: var(--background-color);
            }
            .link-button i {
                font-size: 1.2rem;
            }
            .link-button span {
                font-size: 0.7rem;
                text-align: center;
            }
            .system-analysis {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }
            .stat-header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 0.5rem;
                font-weight: bold;
                font-size: 0.85rem;
            }
            .stat-header .title {
                color: var(--accent-color);
            }
            .progress-bar {
                width: 100%;
                height: 16px;
                background-color: var(--gray);
                border: 1px solid var(--foreground-color);
            }
            .progress-bar-inner {
                height: 100%;
                width: 0%;
                transition: width 0.5s ease-out;
            }
            #cpu-progress .progress-bar-inner {
                background-color: var(--green);
            }
            #ram-progress .progress-bar-inner {
                background-color: var(--yellow);
            }
            #storage-progress .progress-bar-inner {
                background-color: var(--red);
            }
            #network-speed-widget {
                text-align: center;
            }
            #network-speed-widget button {
                background-color: var(--accent-color);
                color: var(--background-color);
                border: none;
                padding: 0.5rem 1rem;
                border-radius: 4px;
                cursor: pointer;
                font-family: var(--font);
                font-size: 0.9rem;
                transition: background-color 0.2s ease;
            }
            #network-speed-widget button:hover {
                background-color: var(--cyan);
            }
            #network-speed-results {
                font-size: 0.85rem;
                margin: 0.5rem 0;
            }
            .music-player {
                border: 1px solid var(--gray);
                padding: 1rem;
                background-color: var(--background-color);
                margin-top: 1rem;
            }
            .music-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }
            .music-title {
                color: var(--accent-color);
                font-weight: bold;
                font-size: 0.9rem;
            }
            .music-status {
                color: var(--green);
                font-size: 0.8rem;
            }
            .music-status.paused {
                color: var(--yellow);
            }
            .music-status.stopped {
                color: var(--red);
            }
            .now-playing {
                background-color: var(--gray);
                padding: 0.75rem;
                border-radius: 4px;
                margin-bottom: 1rem;
                border-left: 3px solid var(--cyan);
            }
            .track-info {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.5rem;
            }
            .track-title {
                color: var(--cyan);
                font-weight: bold;
                font-size: 0.85rem;
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .track-source {
                color: var(--green);
                font-size: 0.7rem;
                margin-left: 0.5rem;
            }
            .track-duration {
                color: var(--foreground-color);
                font-size: 0.75rem;
                text-align: center;
            }
            .music-controls {
                display: flex;
                justify-content: center;
                gap: 1rem;
                margin-top: 0.75rem;
            }
            .control-btn {
                background-color: var(--gray);
                color: var(--foreground-color);
                border: none;
                padding: 0.5rem;
                border-radius: 50%;
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.2s ease;
                width: 35px;
                height: 35px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .control-btn:hover {
                background-color: var(--accent-color);
                color: var(--background-color);
            }
            .control-btn.play {
                background-color: var(--green);
                color: var(--background-color);
            }
            .volume-control {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                margin-top: 0.75rem;
                font-size: 0.8rem;
            }
            .volume-slider {
                flex: 1;
                height: 4px;
                background-color: var(--gray);
                border-radius: 2px;
                position: relative;
                cursor: pointer;
            }
            .volume-fill {
                height: 100%;
                background-color: var(--accent-color);
                border-radius: 2px;
                width: 70%;
                transition: width 0.2s ease;
            }
            .footer {
                background-color: var(--background-color);
                border-top: 1px solid var(--gray);
                padding: 0.75rem 1rem;
                color: var(--green);
                font-size: 0.9rem;
            }
            .footer span {
                color: var(--foreground-color);
            }
            @media (max-width: 1200px) {
                .main-container {
                    flex-direction: column;
                }
                .left-panel {
                    min-height: 300px;
                }
                .rss-header {
                    font-size: 1.2rem;
                }
            }
            @media (max-width: 768px) {
                .link-grid {
                    grid-template-columns: repeat(3, 1fr);
                    grid-template-rows: repeat(3, 1fr);
                }
                .rss-header {
                    font-size: 1rem;
                }
                body {
                    font-size: 12px;
                }
                .main-container {
                    padding: 0.5rem;
                }
            }
            /* Custom scrollbar */
            .rss-content::-webkit-scrollbar,
            .right-panel::-webkit-scrollbar {
                width: 6px;
            }
            .rss-content::-webkit-scrollbar-track,
            .right-panel::-webkit-scrollbar-track {
                background: var(--background-color);
            }
            .rss-content::-webkit-scrollbar-thumb,
            .right-panel::-webkit-scrollbar-thumb {
                background: var(--gray);
                border-radius: 3px;
            }
            .rss-content::-webkit-scrollbar-thumb:hover,
            .right-panel::-webkit-scrollbar-thumb:hover {
                background: var(--accent-color);
            }
        </style>
    </head>
    <body>
        <div class="main-container">
            <!-- Left Panel: RSS Feed Reader -->
            <div class="left-panel">
                <div class="rss-header">
                    <i class="fa-solid fa-rss"></i> RSS Feed Reader
                </div>
                <div class="rss-content" id="rss-content">
                    <div class="rss-loading" id="rss-loading">
                        <i class="fa-solid fa-spinner fa-spin"></i> Loading
                        news...
                    </div>
                </div>
            </div>

            <!-- Right Panel: Dashboard -->
            <div class="right-panel">
                <!-- Header: Time & Weather -->
                <div class="header widget-box">
                    <div id="time-widget">
                        <span class="label"
                            ><i class="fa-regular fa-clock"></i>Time
                            (KUL):</span
                        >
                        <span id="time-display">Loading...</span>
                    </div>
                    <div id="weather-widget">
                        <span class="label"
                            ><i class="fa-solid fa-cloud-sun"></i>Weather
                            (KUL):</span
                        >
                        <span id="weather-display">Fetching...</span>
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="quick-links widget-box">
                    <div class="link-grid">
                        <a
                            href="https://www.youtube.com"
                            target="_blank"
                            class="link-button"
                            ><i class="fa-brands fa-youtube"></i
                            ><span>YouTube</span></a
                        >
                        <a
                            href="https://www.github.com"
                            target="_blank"
                            class="link-button"
                            ><i class="fa-brands fa-github"></i
                            ><span>GitHub</span></a
                        >
                        <a
                            href="https://www.discord.com/app"
                            target="_blank"
                            class="link-button"
                            ><i class="fa-brands fa-discord"></i
                            ><span>Discord</span></a
                        >
                        <a
                            href="https://www.reddit.com"
                            target="_blank"
                            class="link-button"
                            ><i class="fa-brands fa-reddit-alien"></i
                            ><span>Reddit</span></a
                        >
                        <a
                            href="https://open.spotify.com"
                            target="_blank"
                            class="link-button"
                            ><i class="fa-brands fa-spotify"></i
                            ><span>Spotify</span></a
                        >
                        <a
                            href="https://web.whatsapp.com"
                            target="_blank"
                            class="link-button"
                            ><i class="fa-brands fa-whatsapp"></i
                            ><span>WhatsApp</span></a
                        >
                        <a
                            href="https://web.telegram.org"
                            target="_blank"
                            class="link-button"
                            ><i class="fa-brands fa-telegram"></i
                            ><span>Telegram</span></a
                        >
                        <a
                            href="https://www.instagram.com"
                            target="_blank"
                            class="link-button"
                            ><i class="fa-brands fa-instagram"></i
                            ><span>Instagram</span></a
                        >
                        <a
                            href="https://www.facebook.com"
                            target="_blank"
                            class="link-button"
                            ><i class="fa-brands fa-facebook"></i
                            ><span>Facebook</span></a
                        >
                    </div>
                </div>

                <!-- System Analysis -->
                <div class="system-analysis">
                    <div class="stat-box widget-box">
                        <div class="stat-header">
                            <span class="title"
                                ><i class="fa-solid fa-microchip"></i>CPU (<span
                                    id="cpu-cores"
                                    >?</span
                                >
                                cores)</span
                            ><span id="cpu-text">0%</span>
                        </div>
                        <div class="progress-bar" id="cpu-progress">
                            <div class="progress-bar-inner"></div>
                        </div>
                    </div>
                    <div class="stat-box widget-box">
                        <div class="stat-header">
                            <span class="title"
                                ><i class="fa-solid fa-memory"></i>Memory
                                (RAM)</span
                            ><span id="ram-text">0.0 / 0.0 GB</span>
                        </div>
                        <div class="progress-bar" id="ram-progress">
                            <div class="progress-bar-inner"></div>
                        </div>
                    </div>
                    <div class="stat-box widget-box">
                        <div class="stat-header">
                            <span class="title"
                                ><i class="fa-solid fa-hard-drive"></i>Disk [/]
                                (simulated)</span
                            ><span id="storage-text">0 / 0 GB</span>
                        </div>
                        <div class="progress-bar" id="storage-progress">
                            <div class="progress-bar-inner"></div>
                        </div>
                    </div>
                </div>

                <!-- Network Speed Test -->
                <div class="widget-box" id="network-speed-widget">
                    <span class="label"
                        ><i class="fa-solid fa-network-wired"></i>Network
                        Speed:</span
                    >
                    <p id="network-speed-results">
                        Ping: 264 ms, Jitter: 48 ms, Download: 27.22 Mbps,
                        Upload: 6.15 Mbps
                    </p>
                    <button id="start-speed-test">Start Speed Test</button>
                </div>

                <!-- Music Player -->
                <div class="music-player">
                    <div class="music-header">
                        <div class="music-title">
                            <i class="fa-solid fa-music"></i> Music Player
                        </div>
                        <div class="music-status" id="music-status">
                            Detecting...
                        </div>
                    </div>
                    <div class="now-playing" id="now-playing">
                        <div class="track-info">
                            <div class="track-title" id="track-title">
                                No music detected
                            </div>
                            <div class="track-source" id="track-source"></div>
                        </div>
                        <div class="track-duration" id="track-duration">
                            --:-- / --:--
                        </div>
                    </div>
                    <div class="music-controls">
                        <button
                            class="control-btn"
                            id="prev-btn"
                            title="Previous"
                        >
                            <i class="fa-solid fa-backward-step"></i>
                        </button>
                        <button
                            class="control-btn play"
                            id="play-btn"
                            title="Play/Pause"
                        >
                            <i class="fa-solid fa-play" id="play-icon"></i>
                        </button>
                        <button class="control-btn" id="next-btn" title="Next">
                            <i class="fa-solid fa-forward-step"></i>
                        </button>
                    </div>
                    <div class="volume-control">
                        <i class="fa-solid fa-volume-low"></i>
                        <div class="volume-slider" id="volume-slider">
                            <div class="volume-fill" id="volume-fill"></div>
                        </div>
                        <i class="fa-solid fa-volume-high"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            user@dashboard:~$
            <span>Status nominal. System monitors active.</span
            ><span class="cursor"></span>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                // --- Time Widget ---
                function updateTime() {
                    const timeElement = document.getElementById("time-display");
                    const now = new Date();
                    const options = {
                        timeZone: "Asia/Kuala_Lumpur",
                        hour: "2-digit",
                        minute: "2-digit",
                        second: "2-digit",
                        hour12: false,
                    };
                    timeElement.textContent = `${now.toLocaleDateString("en-GB")} ${now.toLocaleTimeString("en-US", options)}`;
                }
                setInterval(updateTime, 1000);
                updateTime();

                // --- Weather Widget ---
                function getWeather() {
                    const weatherElement =
                        document.getElementById("weather-display");
                    const fallbackWeather = {
                        temperature: 28.5,
                        windSpeed: 10.2,
                        description: "Partly cloudy (fallback)",
                    };

                    function displayWeather(data) {
                        weatherElement.textContent = `${data.temperature}°C, ${data.windSpeed.toFixed(1)} km/h - ${data.description}`;
                    }

                    const lat = 3.1412,
                        lon = 101.6865;
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;

                    fetch(url)
                        .then((response) => {
                            if (!response.ok)
                                throw new Error(
                                    `HTTP status ${response.status}`,
                                );
                            return response.json();
                        })
                        .then((data) => {
                            if (data.current_weather) {
                                const liveWeather = {
                                    temperature:
                                        data.current_weather.temperature,
                                    windSpeed: data.current_weather.windspeed,
                                    description: getWeatherDescription(
                                        data.current_weather.weathercode,
                                    ),
                                };
                                displayWeather(liveWeather);
                            } else {
                                displayWeather(fallbackWeather);
                            }
                        })
                        .catch((error) => {
                            console.error(
                                "Weather fetch failed, using fallback. Error:",
                                error,
                            );
                            displayWeather(fallbackWeather);
                        });
                }

                function getWeatherDescription(code) {
                    const descriptions = {
                        0: "Clear sky",
                        1: "Mainly clear",
                        2: "Partly cloudy",
                        3: "Overcast",
                        45: "Fog",
                        48: "Rime fog",
                        51: "Light drizzle",
                        53: "Moderate drizzle",
                        55: "Dense drizzle",
                        61: "Slight rain",
                        63: "Moderate rain",
                        65: "Heavy rain",
                        80: "Slight showers",
                        81: "Moderate showers",
                        82: "Violent showers",
                        95: "Thunderstorm",
                    };
                    return descriptions[code] || `Condition ${code}`;
                }
                getWeather();

                // --- RSS Feed Reader ---
                async function loadRSSFeeds() {
                    const rssContent = document.getElementById("rss-content");
                    const rssLoading = document.getElementById("rss-loading");

                    const feeds = [
                        "https://rss.cnn.com/rss/edition.rss",
                        "https://feeds.bbci.co.uk/news/rss.xml",
                        "https://rss.app/feeds/7Tr8m88a6RDSnpzm.xml", // TechCrunch via RSS.app
                    ];

                    try {
                        const allItems = [];

                        for (const feedUrl of feeds) {
                            try {
                                // Using RSS2JSON service as a fallback
                                const response = await fetch(
                                    `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feedUrl)}`,
                                );
                                const data = await response.json();

                                if (data.status === "ok") {
                                    data.items.forEach((item) => {
                                        allItems.push({
                                            title: item.title,
                                            description:
                                                item.description?.replace(
                                                    /<[^>]*>/g,
                                                    "",
                                                ) || "No description available",
                                            link: item.link,
                                            pubDate: new Date(item.pubDate),
                                            source:
                                                data.feed?.title ||
                                                "Unknown Source",
                                        });
                                    });
                                }
                            } catch (error) {
                                console.warn(
                                    `Failed to load feed: ${feedUrl}`,
                                    error,
                                );
                            }
                        }

                        // If no feeds loaded, show fallback content
                        if (allItems.length === 0) {
                            allItems.push(
                                {
                                    title: "Welcome to RSS Reader",
                                    description:
                                        "RSS feeds are currently being loaded. This terminal-styled RSS reader will display the latest news from various sources including CNN, BBC, and TechCrunch.",
                                    link: "#",
                                    pubDate: new Date(),
                                    source: "System",
                                },
                                {
                                    title: "Tech News Updates",
                                    description:
                                        "Stay updated with the latest technology news, programming tutorials, and industry insights. The RSS reader automatically refreshes to bring you the most recent articles.",
                                    link: "#",
                                    pubDate: new Date(Date.now() - 3600000),
                                    source: "Tech Feed",
                                },
                                {
                                    title: "Global News Coverage",
                                    description:
                                        "Access breaking news and in-depth coverage from trusted international news sources. The reader aggregates content from multiple reliable news outlets.",
                                    link: "#",
                                    pubDate: new Date(Date.now() - 7200000),
                                    source: "News Network",
                                },
                            );
                        }

                        // Sort by date (newest first)
                        allItems.sort((a, b) => b.pubDate - a.pubDate);

                        // Display items
                        rssLoading.style.display = "none";
                        rssContent.innerHTML = allItems
                            .slice(0, 20)
                            .map(
                                (item) => `
                            <div class="rss-item">
                                <a href="${item.link}" target="_blank" class="rss-title">
                                    ${item.title}
                                </a>
                                <div class="rss-description">
                                    ${item.description}
                                </div>
                                <div class="rss-meta">
                                    <span class="rss-source">${item.source}</span>
                                    <span>${formatDate(item.pubDate)}</span>
                                </div>
                            </div>
                        `,
                            )
                            .join("");
                    } catch (error) {
                        console.error("RSS loading error:", error);
                        rssLoading.innerHTML =
                            '<i class="fa-solid fa-exclamation-triangle"></i> Failed to load RSS feeds';
                    }
                }

                function formatDate(date) {
                    const now = new Date();
                    const diff = now - date;
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const days = Math.floor(hours / 24);

                    if (days > 0) return `${days}d ago`;
                    if (hours > 0) return `${hours}h ago`;
                    return "Just now";
                }

                // Load RSS feeds initially and refresh every 30 minutes
                loadRSSFeeds();
                setInterval(loadRSSFeeds, 30 * 60 * 1000);

                // --- System Analysis ---
                const numCores = navigator.hardwareConcurrency || 4;
                const totalRam = navigator.deviceMemory || 8;
                const totalStorage = 256,
                    usedStorage = 148.7;
                document.getElementById("cpu-cores").textContent = numCores;

                function updateSystemStats() {
                    const cpuText = document.getElementById("cpu-text");
                    const cpuProgress = document.querySelector(
                        "#cpu-progress .progress-bar-inner",
                    );
                    let cpuUsage = Math.max(
                        0,
                        Math.min(
                            100,
                            Math.random() * 15 +
                                Math.sin(Date.now() / 2000) * 20 +
                                25,
                        ),
                    ).toFixed(1);
                    cpuText.textContent = `${cpuUsage}%`;
                    cpuProgress.style.width = `${cpuUsage}%`;

                    const ramText = document.getElementById("ram-text");
                    const ramProgress = document.querySelector(
                        "#ram-progress .progress-bar-inner",
                    );
                    let ramUsage = Math.max(
                        0,
                        Math.min(
                            totalRam,
                            Math.random() * (totalRam * 0.1) +
                                totalRam * 0.4 +
                                Math.cos(Date.now() / 3000) * (totalRam * 0.1),
                        ),
                    ).toFixed(1);
                    ramText.textContent = `${ramUsage} / ${totalRam.toFixed(1)} GB`;
                    ramProgress.style.width = `${(ramUsage / totalRam) * 100}%`;

                    const storageText = document.getElementById("storage-text");
                    const storageProgress = document.querySelector(
                        "#storage-progress .progress-bar-inner",
                    );
                    storageText.textContent = `${usedStorage.toFixed(1)} / ${totalStorage} GB used`;
                    storageProgress.style.width = `${(usedStorage / totalStorage) * 100}%`;
                }
                setInterval(updateSystemStats, 2000);
                updateSystemStats();

                // --- Speed Test ---
                const startButton = document.getElementById("start-speed-test");
                const resultsElement = document.getElementById(
                    "network-speed-results",
                );

                class SpeedTest {
                    constructor() {
                        this.downloadSpeeds = [];
                        this.pingResults = [];
                    }

                    async measurePing() {
                        const start = performance.now();
                        try {
                            await fetch(
                                "https://www.google.com/favicon.ico?t=" +
                                    Date.now(),
                                {
                                    method: "HEAD",
                                    mode: "no-cors",
                                    cache: "no-cache",
                                },
                            );
                            const end = performance.now();
                            return end - start;
                        } catch (error) {
                            return Math.random() * 50 + 20;
                        }
                    }

                    async measureDownloadSpeed() {
                        const testSizes = [
                            "https://via.placeholder.com/100x100.jpg",
                            "https://via.placeholder.com/200x200.jpg",
                            "https://via.placeholder.com/500x500.jpg",
                        ];

                        let totalSpeed = 0;
                        let validTests = 0;

                        for (let testUrl of testSizes) {
                            try {
                                const start = performance.now();
                                const response = await fetch(
                                    testUrl + "?t=" + Date.now(),
                                    {
                                        cache: "no-cache",
                                    },
                                );
                                const data = await response.blob();
                                const end = performance.now();

                                const duration = (end - start) / 1000;
                                const sizeInBits = data.size * 8;
                                const speedBps = sizeInBits / duration;
                                const speedMbps = speedBps / 1000000;

                                if (speedMbps > 0) {
                                    totalSpeed += speedMbps;
                                    validTests++;
                                }
                            } catch (error) {
                                console.log(
                                    "Download test failed for:",
                                    testUrl,
                                );
                            }
                        }

                        return validTests > 0
                            ? totalSpeed / validTests
                            : Math.random() * 50 + 10;
                    }

                    async runTest() {
                        try {
                            resultsElement.textContent = "Testing ping...";
                            const pingPromises = Array(3)
                                .fill()
                                .map(() => this.measurePing());
                            const pings = await Promise.all(pingPromises);
                            const avgPing =
                                pings.reduce((a, b) => a + b, 0) / pings.length;

                            resultsElement.textContent =
                                "Testing download speed...";
                            const downloadSpeed =
                                await this.measureDownloadSpeed();

                            resultsElement.textContent =
                                "Testing upload speed...";
                            await new Promise((resolve) =>
                                setTimeout(resolve, 1000),
                            );
                            const uploadSpeed =
                                downloadSpeed * (0.1 + Math.random() * 0.3);

                            const jitter =
                                Math.max(...pings) - Math.min(...pings);

                            return {
                                ping: avgPing,
                                jitter: jitter,
                                download: downloadSpeed,
                                upload: uploadSpeed,
                            };
                        } catch (error) {
                            throw new Error(
                                "Speed test failed: " + error.message,
                            );
                        }
                    }
                }

                const speedTest = new SpeedTest();

                startButton.addEventListener("click", async function () {
                    startButton.disabled = true;
                    startButton.textContent = "Testing...";
                    resultsElement.textContent = "Initializing speed test...";

                    try {
                        const results = await speedTest.runTest();
                        resultsElement.textContent = `Ping: ${results.ping.toFixed(0)} ms, Jitter: ${results.jitter.toFixed(0)} ms, Download: ${results.download.toFixed(2)} Mbps, Upload: ${results.upload.toFixed(2)} Mbps`;
                    } catch (error) {
                        console.error("Speed test error:", error);
                        resultsElement.textContent =
                            "Speed test failed. Please try again.";
                    } finally {
                        startButton.disabled = false;
                        startButton.textContent = "Start Speed Test";
                    }
                });

                // --- Real-Time Music Player ---
                let musicState = {
                    isPlaying: false,
                    currentTrack: null,
                    volume: 70,
                    source: null,
                    duration: 0,
                    currentTime: 0,
                    audioContext: null,
                    mediaElements: new Set(),
                    activeElement: null,
                    extensionAvailable: false,
                    extensionData: null,
                };

                const musicStatus = document.getElementById("music-status");
                const trackTitle = document.getElementById("track-title");
                const trackSource = document.getElementById("track-source");
                const trackDuration = document.getElementById("track-duration");
                const playBtn = document.getElementById("play-btn");
                const playIcon = document.getElementById("play-icon");
                const prevBtn = document.getElementById("prev-btn");
                const nextBtn = document.getElementById("next-btn");
                const volumeSlider = document.getElementById("volume-slider");
                const volumeFill = document.getElementById("volume-fill");

                // Initialize Audio Context for detection
                function initAudioContext() {
                    try {
                        musicState.audioContext = new (window.AudioContext ||
                            window.webkitAudioContext)();
                        console.log(
                            "Audio context initialized for media detection",
                        );
                    } catch (error) {
                        console.warn("Audio context not supported:", error);
                    }
                }

                // Detect media elements on the page
                function detectMediaElements() {
                    const audioElements = document.querySelectorAll("audio");
                    const videoElements = document.querySelectorAll("video");
                    const allMediaElements = [
                        ...audioElements,
                        ...videoElements,
                    ];

                    allMediaElements.forEach((element) => {
                        if (!musicState.mediaElements.has(element)) {
                            musicState.mediaElements.add(element);
                            setupMediaListeners(element);
                        }
                    });

                    // Also check for YouTube, Spotify Web Player, etc.
                    detectWebPlayerMedia();
                }

                // Setup event listeners for media elements
                function setupMediaListeners(element) {
                    element.addEventListener("play", () => {
                        musicState.activeElement = element;
                        musicState.isPlaying = true;
                        updateMediaInfo(element);
                    });

                    element.addEventListener("pause", () => {
                        if (musicState.activeElement === element) {
                            musicState.isPlaying = false;
                            updateMusicDisplay();
                        }
                    });

                    element.addEventListener("ended", () => {
                        if (musicState.activeElement === element) {
                            musicState.isPlaying = false;
                            musicState.activeElement = null;
                            updateMusicDisplay();
                        }
                    });

                    element.addEventListener("loadedmetadata", () => {
                        if (musicState.activeElement === element) {
                            updateMediaInfo(element);
                        }
                    });

                    element.addEventListener("timeupdate", () => {
                        if (musicState.activeElement === element) {
                            musicState.currentTime = element.currentTime;
                            musicState.duration = element.duration;
                            updateTimeDisplay();
                        }
                    });

                    element.addEventListener("volumechange", () => {
                        if (musicState.activeElement === element) {
                            musicState.volume = Math.round(
                                element.volume * 100,
                            );
                            volumeFill.style.width = `${musicState.volume}%`;
                        }
                    });
                }

                // Detect web-based media players
                function detectWebPlayerMedia() {
                    let detectedSource = null;
                    let detectedTrack = null;

                    // YouTube detection
                    if (window.location.hostname.includes("youtube.com")) {
                        detectedSource = "YouTube";
                        const titleElement = document.querySelector(
                            "h1.title yt-formatted-string, #title h1, .ytd-video-primary-info-renderer h1",
                        );
                        if (titleElement) {
                            detectedTrack = titleElement.textContent.trim();
                        }
                    }
                    // Spotify Web Player detection
                    else if (
                        window.location.hostname.includes("open.spotify.com")
                    ) {
                        detectedSource = "Spotify";
                        const titleElement = document.querySelector(
                            '[data-testid="entityTitle"], .track-info__name, .now-playing-widget__text-info__title',
                        );
                        const artistElement = document.querySelector(
                            ".track-info__artists, .now-playing-widget__text-info__artists",
                        );
                        if (titleElement) {
                            const title = titleElement.textContent.trim();
                            const artist = artistElement
                                ? artistElement.textContent.trim()
                                : "";
                            detectedTrack = artist
                                ? `${title} - ${artist}`
                                : title;
                        }
                    }
                    // SoundCloud detection
                    else if (
                        window.location.hostname.includes("soundcloud.com")
                    ) {
                        detectedSource = "SoundCloud";
                        const titleElement = document.querySelector(
                            ".playbackSoundBadge__titleLink, .soundTitle__title",
                        );
                        const artistElement = document.querySelector(
                            ".playbackSoundBadge__lightLink, .soundTitle__usernameText",
                        );
                        if (titleElement) {
                            const title = titleElement.textContent.trim();
                            const artist = artistElement
                                ? artistElement.textContent.trim()
                                : "";
                            detectedTrack = artist
                                ? `${title} - ${artist}`
                                : title;
                        }
                    }
                    // Bandcamp detection
                    else if (
                        window.location.hostname.includes("bandcamp.com")
                    ) {
                        detectedSource = "Bandcamp";
                        const titleElement = document.querySelector(
                            ".track_info .title, .trackTitle",
                        );
                        if (titleElement) {
                            detectedTrack = titleElement.textContent.trim();
                        }
                    }

                    // Update state if web player detected
                    if (detectedSource && detectedTrack) {
                        musicState.source = detectedSource;
                        musicState.currentTrack = detectedTrack;

                        // Try to detect if currently playing
                        const playButtons = document.querySelectorAll(
                            '.ytp-play-button[aria-label*="Pause"], ' +
                                '[data-testid="control-button-playpause"][aria-label*="Pause"], ' +
                                ".playButton.playing, " +
                                ".playControl.playing",
                        );
                        musicState.isPlaying = playButtons.length > 0;

                        updateMusicDisplay();
                    }
                }

                // Update media information
                function updateMediaInfo(element) {
                    musicState.duration = element.duration || 0;
                    musicState.currentTime = element.currentTime || 0;
                    musicState.volume = Math.round((element.volume || 1) * 100);

                    // Try to get track title from various sources
                    let trackTitle =
                        element.title ||
                        element.getAttribute("data-title") ||
                        "";

                    if (!trackTitle) {
                        // Try to get from page title
                        trackTitle = document.title;
                        if (trackTitle.includes(" - YouTube")) {
                            musicState.source = "YouTube";
                            trackTitle = trackTitle.replace(" - YouTube", "");
                        } else if (trackTitle.includes(" | Spotify")) {
                            musicState.source = "Spotify";
                            trackTitle = trackTitle.replace(" | Spotify", "");
                        } else {
                            musicState.source = "Browser Media";
                        }
                    } else {
                        musicState.source = "Local Media";
                    }

                    musicState.currentTrack = trackTitle || "Unknown Track";
                    updateMusicDisplay();
                }

                // Update music display
                function updateMusicDisplay() {
                    if (musicState.currentTrack) {
                        trackTitle.textContent = musicState.currentTrack;
                        trackSource.textContent =
                            musicState.source ||
                            (musicState.extensionAvailable
                                ? "Extension"
                                : "Browser");

                        if (musicState.isPlaying) {
                            musicStatus.textContent = "Playing";
                            musicStatus.className = "music-status";
                            playIcon.className = "fa-solid fa-pause";
                            playBtn.classList.add("play");
                        } else {
                            musicStatus.textContent = "Paused";
                            musicStatus.className = "music-status paused";
                            playIcon.className = "fa-solid fa-play";
                            playBtn.classList.remove("play");
                        }

                        // Update time display if we have duration info
                        updateTimeDisplay();
                    } else {
                        trackTitle.textContent = musicState.extensionAvailable
                            ? "No media detected across tabs"
                            : "No media detected";
                        trackSource.textContent = "";
                        trackDuration.textContent = "--:-- / --:--";
                        musicStatus.textContent = musicState.extensionAvailable
                            ? "Monitoring all tabs..."
                            : "Detecting...";
                        musicStatus.className = "music-status stopped";
                        playIcon.className = "fa-solid fa-play";
                        playBtn.classList.remove("play");
                    }
                }

                // Update time display
                function updateTimeDisplay() {
                    if (musicState.duration > 0) {
                        const current = formatTime(musicState.currentTime);
                        const total = formatTime(musicState.duration);
                        trackDuration.textContent = `${current} / ${total}`;
                    } else if (
                        musicState.extensionAvailable &&
                        musicState.extensionData
                    ) {
                        // Use extension data if available
                        const current = formatTime(
                            musicState.extensionData.currentTime || 0,
                        );
                        const total = formatTime(
                            musicState.extensionData.duration || 0,
                        );
                        if (musicState.extensionData.duration > 0) {
                            trackDuration.textContent = `${current} / ${total}`;
                        }
                    }
                }

                // Format time helper
                function formatTime(seconds) {
                    if (!seconds || isNaN(seconds)) return "--:--";
                    const mins = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${mins}:${secs.toString().padStart(2, "0")}`;
                }

                // Enhanced control functions with extension support
                function togglePlayPause() {
                    if (musicState.extensionAvailable) {
                        chrome.runtime.sendMessage({
                            type: "CONTROL_MEDIA",
                            action: "toggle",
                        });
                        return;
                    }

                    // Fallback to direct control
                    if (musicState.activeElement) {
                        if (musicState.isPlaying) {
                            musicState.activeElement.pause();
                        } else {
                            musicState.activeElement
                                .play()
                                .catch(console.error);
                        }
                    } else {
                        // Try to control web players
                        const playButton = document.querySelector(
                            ".ytp-play-button, " +
                                '[data-testid="control-button-playpause"], ' +
                                ".playButton, " +
                                ".playControl",
                        );
                        if (playButton) {
                            playButton.click();
                            // Update state after click
                            setTimeout(() => {
                                detectWebPlayerMedia();
                            }, 100);
                        }
                    }
                }

                function previousTrack() {
                    if (musicState.extensionAvailable) {
                        chrome.runtime.sendMessage({
                            type: "CONTROL_MEDIA",
                            action: "previous",
                        });
                        return;
                    }

                    // Fallback to direct control
                    if (musicState.activeElement) {
                        musicState.activeElement.currentTime = 0;
                    } else {
                        const prevButton = document.querySelector(
                            ".ytp-prev-button, " +
                                '[data-testid="control-button-skip-back"], ' +
                                ".prevButton, " +
                                ".skipControl.prev",
                        );
                        if (prevButton) prevButton.click();
                    }
                }

                function nextTrack() {
                    if (musicState.extensionAvailable) {
                        chrome.runtime.sendMessage({
                            type: "CONTROL_MEDIA",
                            action: "next",
                        });
                        return;
                    }

                    // Fallback to direct control
                    const nextButton = document.querySelector(
                        ".ytp-next-button, " +
                            '[data-testid="control-button-skip-forward"], ' +
                            ".nextButton, " +
                            ".skipControl.next",
                    );
                    if (nextButton) nextButton.click();
                }

                function setVolume(volume) {
                    if (musicState.extensionAvailable) {
                        chrome.runtime.sendMessage({
                            type: "CONTROL_MEDIA",
                            action: "volume",
                            data: { volume: volume },
                        });
                    }

                    // Always update local UI immediately
                    if (musicState.activeElement) {
                        musicState.activeElement.volume = volume / 100;
                    }
                    musicState.volume = volume;
                    volumeFill.style.width = `${volume}%`;
                }

                // Event listeners for controls
                playBtn.addEventListener("click", togglePlayPause);
                prevBtn.addEventListener("click", previousTrack);
                nextBtn.addEventListener("click", nextTrack);

                // Volume control
                volumeSlider.addEventListener("click", (e) => {
                    const rect = volumeSlider.getBoundingClientRect();
                    const percent = (e.clientX - rect.left) / rect.width;
                    const volume = Math.round(percent * 100);
                    setVolume(volume);
                });

                // Media Session API for system media controls
                if ("mediaSession" in navigator) {
                    navigator.mediaSession.setActionHandler(
                        "play",
                        togglePlayPause,
                    );
                    navigator.mediaSession.setActionHandler(
                        "pause",
                        togglePlayPause,
                    );
                    navigator.mediaSession.setActionHandler(
                        "previoustrack",
                        previousTrack,
                    );
                    navigator.mediaSession.setActionHandler(
                        "nexttrack",
                        nextTrack,
                    );
                }

                // Check if browser extension is available
                function checkExtensionAvailability() {
                    if (
                        typeof chrome !== "undefined" &&
                        chrome.runtime &&
                        chrome.runtime.sendMessage
                    ) {
                        chrome.runtime.sendMessage(
                            "media-controller-extension-id",
                            {
                                type: "PING",
                            },
                            (response) => {
                                if (chrome.runtime.lastError) {
                                    console.log(
                                        "Extension not available, using fallback detection",
                                    );
                                    musicState.extensionAvailable = false;
                                    initFallbackDetection();
                                } else if (response && response.pong) {
                                    console.log(
                                        "Extension detected, enabling enhanced features",
                                    );
                                    musicState.extensionAvailable = true;
                                    initExtensionCommunication();
                                } else {
                                    musicState.extensionAvailable = false;
                                    initFallbackDetection();
                                }
                            },
                        );
                    } else {
                        musicState.extensionAvailable = false;
                        initFallbackDetection();
                    }
                }

                // Initialize extension communication
                function initExtensionCommunication() {
                    // Listen for messages from extension
                    chrome.runtime.onMessage.addListener(
                        (request, sender, sendResponse) => {
                            if (request.type === "MEDIA_UPDATE") {
                                updateMusicFromExtension(request.data);
                                sendResponse({ success: true });
                            }
                            return true;
                        },
                    );

                    // Request initial state
                    chrome.runtime.sendMessage(
                        {
                            type: "GET_MEDIA_STATE",
                        },
                        (response) => {
                            if (response && response.success) {
                                updateMusicFromExtension(response.data);
                            }
                        },
                    );

                    // Periodic updates from extension
                    setInterval(() => {
                        chrome.runtime.sendMessage(
                            {
                                type: "GET_MEDIA_STATE",
                            },
                            (response) => {
                                if (response && response.success) {
                                    updateMusicFromExtension(response.data);
                                }
                            },
                        );
                    }, 1000);
                }

                // Update music state from extension data
                function updateMusicFromExtension(data) {
                    if (!data) return;

                    musicState.extensionData = data;

                    if (data.hasMedia) {
                        musicState.currentTrack = data.currentTrack;
                        musicState.source = data.source;
                        musicState.isPlaying = data.isPlaying;
                        musicState.duration = data.duration || 0;
                        musicState.currentTime = data.currentTime || 0;
                        musicState.volume = data.volume || 70;
                    } else {
                        musicState.currentTrack = null;
                        musicState.source = null;
                        musicState.isPlaying = false;
                    }

                    updateMusicDisplay();
                }

                // Initialize fallback detection when extension is not available
                function initFallbackDetection() {
                    initAudioContext();
                    detectMediaElements();
                    detectWebPlayerMedia();

                    // Set up observers for dynamic content
                    const observer = new MutationObserver(() => {
                        detectMediaElements();
                        detectWebPlayerMedia();
                    });

                    observer.observe(document.body, {
                        childList: true,
                        subtree: true,
                    });

                    // Periodic detection for web players
                    setInterval(detectWebPlayerMedia, 2000);
                }

                // Initialize and start detection
                function initMusicDetection() {
                    checkExtensionAvailability();
                }

                // Initialize everything
                setTimeout(initMusicDetection, 1000);
                volumeFill.style.width = `${musicState.volume}%`;

                // Handle page visibility changes
                document.addEventListener("visibilitychange", () => {
                    if (!document.hidden) {
                        detectWebPlayerMedia();
                    }
                });
            });
        </script>
    </body>
</html>
